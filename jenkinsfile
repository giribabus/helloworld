pipeline {
    agent any

    environment {
        // Define credentials stored in Jenkins as Secret Text, e.g., 'anypoint-credentials'
        //ANYPOINT_CREDENTIALS = credentials('anypoint-credentials')
		ANYPOINT_CREDENTIALS_USR=credentials('ANYPOINT_CREDENTIALS_USR')
		ANYPOINT_CREDENTIALS_PSW=credentials('ANYPOINT_CREDENTIALS_PSW')
        // Other environment-specific properties can be defined here or passed as parameters
    }

   tools {
        // Install the Maven version configured as "M3" and add it to the path.
        maven "M3"
    }

    stages {
         stage('Checkout Code') {
            steps {
                git(
                    url: 'https://github.com/giribabus/helloworld.git', // Use your repo URL
                    credentialsId: 'git_token', // Use your credential ID
                    branch: 'main' // Specify the branch name
                )
            }
        }
        stage('Build Application') {
            steps {
                echo 'Building the MuleSoft application...'
                // The 'clean install' Maven command compiles and packages the application
                bat 'mvn clean install -DskipTests=true' 
            }
        }

        stage('Run Unit Tests') {
            steps {
                echo 'Running MUnit tests...'
                // The 'test' goal in Munit Maven plugin executes unit tests
                bat 'mvn test' 
            }
        }
      stage('Build and SonarQube Analysis') {
            // The withSonarQubeEnv block automatically injects the server configuration
            steps {
                withSonarQubeEnv(credentialsId: 'SONARQUBE_TOKEN_ID', installationName: 'SonarQube') { // Match names to your Jenkins config
                    bat 'mvn clean install sonar:sonar -Dsonar.projectKey=giribabus_helloworld -Dsonar.sources=src/main/mule' // Modify projectKey and sources path as needed
                }
            }
        }
        stage('Deploy to CloudHub') {
            steps {
                echo 'Deploying to the configured environment...'
                // Deploy command uses the Mule Maven Plugin configuration from pom.xml
                // Credentials are injected securely via environment variables
                bat 'mvn clean deploy -DmuleDeploy -Dusername=${ANYPOINT_CREDENTIALS_USR} -Dpassword=${ANYPOINT_CREDENTIALS_PSW}'
            }
        }
    }
}
